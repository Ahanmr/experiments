let data={sketch:{background:"#FFFFFF03"}},vehicles=[],flow,song,amp,vol,fft,spectrum;function setup(){createCanvas(windowWidth,windowHeight),colorMode(HSL,100),background(data.sketch.background),angleMode(DEGREES),noStroke(),flow=new Flowfield(10),flow.init(),amp=new p5.Amplitude,fft=new p5.FFT(0.8,256);for(var a=0;a<256;a+=1)vehicles[a]=new Vehicle(random(0.1*width,0.9*width),random(0.1*height,0.9*height),a);song=loadSound("/sounds/experiments/115.mp3",loaded)}function loaded(){song.loop()}function draw(){background(data.sketch.background);new p5.Vector(mouseX,mouseY);orbitControl(),camera(0,0,600),spectrum=fft.analyze(),vol=map(amp.getLevel(),0,1,100,700);let b=0;for(var c=0,e=spectrum.length;c<e;c+=1)spectrum[c]>spectrum[b]&&(b=c);let f=0.5*width+map(spectrum[b],0,255,0,0.3*width)*sin(frameCount+map(vol,0,255,0,360)),g=0.5*height+map(spectrum[b],0,255,0,0.3*height)*cos(frameCount+map(vol,0,255,0,360))*tan(frameCount),h=new p5.Vector(f,g);vehicles.forEach(l=>{l.seek(h)}),vehicles.forEach(l=>{0<spectrum[b]&&(l.desired_separation=20+20*cos(frameCount)),l.separate(vehicles),l.update(),l.display2D()})}class Vehicle{constructor(a,b,c){this.location=new p5.Vector(a,b),this.velocity=new p5.Vector,this.acceleration=new p5.Vector(0,0),this.i=c,this.r=map(c,0,25,1,1.1),this.maxSpeed=random(10,10),this.maxForce=5,this.desired_separation=100}applyForce(a){this.acceleration.add(a)}update(){(this.location.x>width||-0>this.location.x)&&(0<this.location.x?this.location.x=-0:this.location.x=width),(this.location.y>height||-0>this.location.y)&&(0<this.location.y?this.location.y=-0:this.location.y=height),this.velocity.add(this.acceleration),this.velocity.limit(this.maxSpeed),this.location.add(this.velocity),this.acceleration.mult(0)}align(a){let b=new p5.Vector(0,0);for(other of a)b.add(other.velocity);b.div(a.length),b.setMag(this.maxspeed);let c=p5.Vector.sub(b,this.velocity);return c.limit(this.maxforce),c}seek(a){let b=p5.Vector.sub(a,this.location),c=b.mag();if(b.normalize(),100>c){let f=map(c,10,100,2,this.maxSpeed);b.mult(f)}else b.mult(this.maxSpeed);let e=p5.Vector.sub(b,this.velocity);e.limit(this.maxForce),this.applyForce(e)}separate(a){let b=new p5.Vector,c=0;if(a.forEach(e=>{let f=p5.Vector.dist(this.location,e.location);if(0<f&&f<this.desired_separation){let g=p5.Vector.sub(this.location,e.location);g.normalize(),b.add(g),c++}}),0<c){b.div(c),b.setMag(this.maxSpeed);let e=p5.Vector.sub(b,this.velocity);e.limit(this.maxForce),this.applyForce(e)}}follow(a){let b=a.lookup(this.location);b.mult(this.maxSpeed);let c=p5.Vector.sub(b,this.velocity);c.limit(this.maxForce),this.applyForce(c)}display3D(){push(),translate(this.location.x,this.location.y),specularMaterial(map(this.velocity.mag(),0,20,0,100),100,100,90),sphere(2*this.r),pop()}display2D(){let a=this.velocity.heading()+PI/2;push(),translate(this.location.x,this.location.y),rotate(a),fill(map(this.velocity.mag(),0,this.maxSpeed,0,100),100,30),triangle(this.r,this.r,-this.r,this.r,0,2*-this.r),pop()}}class Flowfield{constructor(a){this.resolution=a,this.columns=width/a,this.rows=height/a,this.depth=0.5*(width+height)/a,this.field=[]}init(){let a=0;for(var b=0;b<this.columns;b+=1){let f=0;this.field[b]=[];for(var c=0;c<this.rows;c+=1){let g=0;this.field[b][c]=[];for(var e=0;e<this.depth;e+=1){let h=map(noise(a,f,g),0,1,0,2*PI);this.field[b][c][e]=new p5.Vector(cos(h),sin(h),0),g+=0.1}f+=0.1}a+=0.1}}lookup(a){let b=int(constrain(a.x/this.resolution,0,this.columns-1)),c=int(constrain(a.y/this.resolution,0,this.rows-1));return this.field[b][c][0].copy()}}